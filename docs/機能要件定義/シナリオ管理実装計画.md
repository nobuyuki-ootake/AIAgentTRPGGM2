# TRPG シナリオ追体験システム実装計画

## 🎭 概要

このドキュメントは、新要件定義に基づく**AI Agent GMとの対話による物語追体験システム**の実装計画を管理します。プレイヤーが「シナリオ（超抽象）→マイルストーン（抽象）→エンティティ（具体）」の3層構造を通じて没入感の高いTRPG体験を得られるシステムの実装を段階的に進めます。

## 🎯 実装方針

### **体験設計ファーストアプローチ**
技術実装よりも**プレイヤー物語体験の品質**を最優先とし、以下の順序で実装を進めます：

1. **物語追体験基盤設計** - 3層抽象構造の確立
2. **AI Agent GM対話システム** - 核心機能の実装  
3. **シナリオ生成システム** - コンテンツ自動生成
4. **体験最適化システム** - 品質向上・個人適応

### **既存実装の最大活用**
調査により判明した**優秀な既存基盤を最大限活用**し、新規開発を最小化：

- **完璧な型定義システム**: `packages/types/src/index.ts` (2,487行) - 既にAI Agent GM向け設計
- **完璧なデータベース**: AI特化テーブル完備 - 軽微な拡張のみ
- **堅実なAPI基盤**: 基本CRUD完備 - AI統合層追加のみ

### **堅実性重視**
- **段階的実装**: 各Phase完了後に動作確認・品質保証
- **後方互換性**: 既存実装を破壊しない拡張アプローチ
- **再実装容易性**: 明確な依存関係・モジュール化設計
- **チーム開発対応**: 独立性の高いPhase分割

## 📊 現在の実装状況（再評価）

### ⭐ **完璧レベル（既存活用）**
- ✅ **型定義システム**: AIMilestone, EntityPool, AI関連型 - 追加実装不要
- ✅ **データベーススキーマ**: AI Agent GM特化設計 - 軽微拡張のみ
- ✅ **基本API**: CRUD操作完備 - AI統合層追加のみ

### 🔶 **良好レベル（軽微拡張）**
- 🔄 **AIサービス基盤**: systemPrompts.ts拡張
- 🔄 **フロントエンド基盤**: コンポーネント追加・調整

### ❌ **新規実装必要**
- 🆕 **AI Agent GM対話エンジン**: 物語誘導・自然な応答生成
- 🆕 **3層抽象管理システム**: シナリオ→マイルストーン→エンティティ
- 🆕 **体験品質監視**: 没入感・理解度・関与度測定
- 🆕 **物語追体験UI**: プレイヤー中心インターフェース

---

## 🗂️ Phase 1: 物語追体験基盤設計（1週間）

### **目標**: 3層抽象構造の技術基盤確立

#### 1.1 シナリオ概念の追加 📖

**実装内容**:
```sql
-- データベース拡張（最小限）
ALTER TABLE sessions ADD COLUMN scenario_title TEXT;
ALTER TABLE sessions ADD COLUMN scenario_description TEXT; -- 400字程度
ALTER TABLE sessions ADD COLUMN scenario_theme TEXT;
```

**作業項目**:
- [ ] **データベーススキーマ拡張**: sessionsテーブルへの3フィールド追加
- [ ] **型定義追加**: SessionScenario インターフェース追加
- [ ] **API拡張**: シナリオ情報取得・更新エンドポイント
- [ ] **フロントエンド**: シナリオ表示コンポーネント作成

#### 1.2 3層構造の統合管理 🏗️

**実装内容**:
```typescript
// 新規サービス作成
class ThreeLayerScenarioService {
  async generateScenarioWithLayers(request: ScenarioGenerationRequest): Promise<ThreeLayerStructure>;
  async validateLayerConsistency(structure: ThreeLayerStructure): Promise<ValidationResult>;
  async getScenarioProgress(sessionId: string): Promise<ProgressState>;
}
```

**作業項目**:
- [ ] **統合管理サービス**: 3層構造の一貫性管理
- [ ] **進捗計算システム**: マイルストーン進捗の自動計算
- [ ] **整合性検証**: シナリオ→マイルストーン→エンティティの論理チェック

#### 1.3 基盤APIの拡張 🔌

**作業項目**:
- [ ] **新エンドポイント**: `/api/scenario-generation/three-layer`
- [ ] **進捗管理API**: `/api/scenario-progress/:sessionId`
- [ ] **整合性チェックAPI**: `/api/scenario-validation/:sessionId`

**成功条件**:
- ✅ シナリオ概要の生成・表示・保存が正常動作
- ✅ マイルストーン→エンティティの関連付けが適切に管理
- ✅ 3層構造の整合性が自動検証される

---

## 🗂️ Phase 2: AI Agent GM対話システム（2週間）

### **目標**: 核心機能であるAI Agent GMとの自然な対話実現

#### 2.1 対話エンジンの実装 🤖

**実装内容**:
```typescript
// 新規対話エンジン
class AIGMConversationEngine {
  async generateNaturalGuidance(context: ConversationContext): Promise<GuidanceResponse>;
  async processPlayerAction(action: PlayerAction): Promise<ActionResponse>;
  async updateNarrativeProgression(progress: ProgressUpdate): Promise<NarrativeState>;
}
```

**作業項目**:
- [ ] **自然言語対話**: プレイヤー入力の理解・文脈維持・応答生成
- [ ] **物語誘導システム**: 興味喚起・手がかり提示・次行動提案
- [ ] **エンティティクリア支援**: 柔軟なアプローチ対応・適切な反応

#### 2.2 systemPrompts.ts の拡張 📝

**実装内容**:
```typescript
// 既存ファイル拡張
export const AI_GM_PROMPTS = {
  SCENARIO_INTRODUCTION: "物語導入プロンプト",
  ENTITY_DISCOVERY: "エンティティ発見支援プロンプト",
  PROGRESS_GUIDANCE: "進行誘導プロンプト",
  NATURAL_TRANSITION: "自然な場面転換プロンプト"
};
```

**作業項目**:
- [ ] **物語誘導プロンプト**: 自然で魅力的な誘導パターン
- [ ] **エンティティ対話プロンプト**: 各エンティティタイプ別応答
- [ ] **進捗反映プロンプト**: マイルストーン進捗の自然な表現

#### 2.3 対話インターフェースの実装 💬

**作業項目**:
- [ ] **AI GM対話パネル**: リアルタイム対話・文脈維持・履歴管理
- [ ] **物語進行表示**: 自然な進捗表現・次段階暗示
- [ ] **体験品質フィードバック**: 没入感・理解度の測定

**成功条件**:
- ✅ AI GMとの自然で魅力的な対話が実現
- ✅ エンティティクリアが物語的に表現される
- ✅ プレイヤーが物語進行を実感できる

---

## 🗂️ Phase 3: シナリオ生成システム（2週間）

### **目標**: 高品質な物語コンテンツの自動生成

#### 3.1 統合生成エンジンの実装 🎬

**実装内容**:
```typescript
// 既存のaiMilestoneGenerationService.ts拡張
class EnhancedScenarioGenerator extends AIMilestoneGenerationService {
  async generateWithStoryStructure(request: StoryGenerationRequest): Promise<CompleteScenario>;
  async ensureNarrativeCoherence(scenario: CompleteScenario): Promise<QualityAssurance>;
  async adaptToTheme(scenario: CompleteScenario, theme: GameTheme): Promise<ThemeAdaptedScenario>;
}
```

**作業項目**:
- [ ] **物語一貫性エンジン**: シナリオの論理的整合性保証
- [ ] **テーマ適応生成**: ゲームテーマに沿ったコンテンツ生成
- [ ] **品質自動評価**: 生成コンテンツの物語品質チェック

#### 3.2 既存生成機能の強化 ⚡

**作業項目**:
- [ ] **マイルストーン生成**: 物語構造を考慮した目標設定
- [ ] **エンティティ生成**: 物語文脈に沿った要素生成
- [ ] **配置最適化**: プレイヤー体験を考慮した配置

#### 3.3 生成品質保証システム 🎯

**作業項目**:
- [ ] **自動品質チェック**: 物語一貫性・テーマ適合性・体験品質
- [ ] **生成ログ・分析**: 生成プロセスの記録・改善点分析
- [ ] **A/Bテスト基盤**: 複数生成結果の比較・最適化

**成功条件**:
- ✅ 一貫性のある高品質なシナリオが自動生成される
- ✅ テーマに適合したコンテンツが安定して生成される
- ✅ 生成品質が定量的に評価・改善される

---

## 🗂️ Phase 4: 体験最適化システム（1週間）

### **目標**: プレイヤー個別最適化・体験品質向上

#### 4.1 体験品質監視システム 📊

**実装内容**:
```typescript
// 新規監視システム
class ExperienceQualityMonitor {
  async measureImmersion(playerBehavior: BehaviorData): Promise<ImmersionMetrics>;
  async detectEngagementLevel(sessionData: SessionData): Promise<EngagementLevel>;
  async identifyImprovementAreas(qualityData: QualityData): Promise<ImprovementSuggestions>;
}
```

**作業項目**:
- [ ] **没入感測定**: プレイヤー行動パターンから没入度算出
- [ ] **理解度評価**: 物語進行理解・選択適切性の評価
- [ ] **関与度監視**: 積極性・興味レベルの測定

#### 4.2 個人最適化システム 🎛️

**作業項目**:
- [ ] **プレイスタイル学習**: 個人の好み・行動パターン学習
- [ ] **適応的難易度**: 個人レベルに応じた動的調整
- [ ] **個別カスタマイゼーション**: AI GM応答・誘導スタイルの個人化

#### 4.3 体験改善システム 🚀

**作業項目**:
- [ ] **リアルタイム改善**: 体験阻害要因の即座検出・修正
- [ ] **学習フィードバック**: プレイヤー行動からのシステム学習
- [ ] **継続改善**: セッション後の体験分析・システム改善

**成功条件**:
- ✅ プレイヤー個人に最適化された体験が提供される
- ✅ 体験品質が定量的に測定・改善される
- ✅ 継続的な学習・改善サイクルが確立される

---

## 📋 実装管理

### 🎯 各Phase完了条件

#### Phase 1 完了条件
- [ ] シナリオ概要の生成・表示・保存機能
- [ ] 3層構造の統合管理システム
- [ ] 基盤APIの拡張完了
- [ ] 基本的な整合性検証機能

#### Phase 2 完了条件  
- [ ] AI Agent GMとの自然な対話機能
- [ ] エンティティクリア支援システム
- [ ] 物語進行誘導機能
- [ ] 対話品質の基本レベル達成

#### Phase 3 完了条件
- [ ] 高品質シナリオの自動生成
- [ ] 物語一貫性保証システム
- [ ] テーマ適応生成機能
- [ ] 生成品質の定量評価

#### Phase 4 完了条件
- [ ] 体験品質監視システム
- [ ] 個人最適化機能
- [ ] 継続改善システム
- [ ] 成功指標の達成

### 📊 品質保証基準

#### 技術品質
- **コードカバレッジ**: 80%以上
- **API応答時間**: 平均2秒以内
- **エラー率**: 1%未満
- **システム稼働率**: 99%以上

#### 体験品質
- **物語理解度**: 90%以上
- **没入感**: 85%以上
- **達成感**: 88%以上  
- **リプレイ意欲**: 80%以上

### 🔄 継続改善サイクル

#### 週次レビュー
- [ ] 実装進捗確認
- [ ] 品質指標測定
- [ ] 課題・改善点抽出
- [ ] 次週計画調整

#### Phase完了レビュー
- [ ] 完了条件達成確認
- [ ] 体験品質評価
- [ ] 次Phase要件確認
- [ ] リスク・対策評価

### 🚨 リスク管理

#### 技術リスク
- **AI応答品質**: 複数プロバイダー対応・品質監視
- **パフォーマンス**: 継続的監視・最適化
- **データ整合性**: 自動検証・バックアップ

#### 体験リスク
- **没入感阻害**: リアルタイム監視・即座改善
- **物語一貫性**: 自動チェック・品質保証
- **個人適応**: 学習精度向上・フィードバック活用

---

## 🎉 最終成果目標

このシナリオ追体験システム実装により実現される価値：

### **プレイヤー体験価値**
- 📖 **没入感の高い物語追体験**: 一貫した世界観・自然な進行
- 🎯 **個人最適化された体験**: 好み・レベルに応じた調整
- 🏆 **充実した達成感**: 明確な物語完結・成長実感

### **システム技術価値**
- 🤖 **高品質AI Agent GM**: 自然で魅力的な対話相手
- 🏗️ **堅牢な3層抽象設計**: 再利用可能・拡張容易な構造
- 📊 **継続改善システム**: 自動学習・品質向上

### **開発・運用価値**
- 🔄 **再実装容易性**: 明確な依存関係・モジュール設計
- 👥 **チーム開発対応**: 独立性の高いPhase分割
- 📈 **継続的改善**: 定量的品質管理・学習サイクル

この実装計画により、**「物語を楽しむTRPG」**という核心価値を技術的に実現し、プレイヤーに真の意味でのTRPG体験を提供できます。