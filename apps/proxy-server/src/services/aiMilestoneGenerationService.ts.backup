import { Database } from 'better-sqlite3';
import { randomUUID } from 'crypto';
import { 
  AIMilestone, 
  EntityPool, 
  EntityPoolCollection,
  MilestoneGenerationRequest,
  MilestoneGenerationResponse,
  ThemeAdaptation,
  SessionDurationConfig,
  ID,
  PoolEnemy,
  InteractiveEvent,
  PoolNPC,
  PoolItem,
  PoolQuest,
  MilestoneType
} from '@ai-agent-trpg/types';
import { getDatabase } from '../database/database';
import { logger } from '../utils/logger';
import { AIServiceError } from '../middleware/errorHandler';
import { getAIService } from './aiService';


export class AIMilestoneGenerationService {
  private db: Database;

  constructor() {
    this.db = getDatabase();
    this.initTables();
  }

  private initTables(): void {
    // AI ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«
    this.db.exec(`
      CREATE TABLE IF NOT EXISTS ai_milestones (
        id TEXT PRIMARY KEY,
        campaign_id TEXT NOT NULL,
        session_id TEXT NOT NULL,
        title TEXT NOT NULL,
        description TEXT NOT NULL,
        type TEXT NOT NULL,
        target_id TEXT NOT NULL,
        target_details TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'pending',
        progress INTEGER NOT NULL DEFAULT 0,
        required_conditions TEXT NOT NULL DEFAULT '[]',
        reward TEXT NOT NULL DEFAULT '{}',
        created_at TEXT NOT NULL,
        completed_at TEXT,
        FOREIGN KEY (campaign_id) REFERENCES campaigns(id) ON DELETE CASCADE
      )
    `);

    // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«
    this.db.exec(`
      CREATE TABLE IF NOT EXISTS entity_pools (
        id TEXT PRIMARY KEY,
        campaign_id TEXT NOT NULL,
        session_id TEXT NOT NULL,
        theme_id TEXT NOT NULL,
        entities TEXT NOT NULL,
        generated_at TEXT NOT NULL,
        last_updated TEXT NOT NULL,
        FOREIGN KEY (campaign_id) REFERENCES campaigns(id) ON DELETE CASCADE
      )
    `);

    // ãƒ†ãƒ¼ãƒé©å¿œãƒ†ãƒ¼ãƒ–ãƒ«
    this.db.exec(`
      CREATE TABLE IF NOT EXISTS theme_adaptations (
        id TEXT PRIMARY KEY,
        theme_id TEXT NOT NULL,
        allowed_entity_types TEXT NOT NULL,
        restricted_entity_types TEXT NOT NULL,
        specializations TEXT NOT NULL,
        content_modifiers TEXT NOT NULL,
        created_at TEXT NOT NULL
      )
    `);

    // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç”Ÿæˆå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
    this.db.exec(`
      CREATE TABLE IF NOT EXISTS milestone_generation_history (
        id TEXT PRIMARY KEY,
        campaign_id TEXT NOT NULL,
        session_id TEXT NOT NULL,
        generation_metadata TEXT NOT NULL,
        generated_at TEXT NOT NULL,
        FOREIGN KEY (campaign_id) REFERENCES campaigns(id) ON DELETE CASCADE
      )
    `);
  }

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãƒ»ãƒ—ãƒ¼ãƒ«ç”Ÿæˆï¼ˆãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰
   */
  async generateMilestonesAndPools(request: MilestoneGenerationRequest): Promise<MilestoneGenerationResponse> {
    const startTime = Date.now();
    
    try {
      logger.info('ğŸ¯ AI ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç”Ÿæˆé–‹å§‹ï¼ˆãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼‰', { 
        campaignId: request.campaignId,
        sessionId: request.sessionId,
        milestoneCount: request.milestoneCount 
      });

      // Phase 1: ç›®æ¨™è¨­è¨ˆ
      logger.info('ğŸ“‹ Phase 1: ç›®æ¨™è¨­è¨ˆé–‹å§‹');
      const themeAdaptation = await this.generateThemeAdaptation(request.themeId, request.sessionDuration);
      const milestoneOutlines = await this.generateMilestoneOutlines(request, themeAdaptation);
      const milestoneRelations = await this.defineMilestoneRelations(milestoneOutlines);
      
      // Phase 2: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
      logger.info('ğŸ² Phase 2: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆé–‹å§‹');
      const coreEntityRequirements = await this.defineCoreEntityRequirements(milestoneRelations, themeAdaptation);
      const coreEntities = await this.generateCoreEntities(coreEntityRequirements, request, themeAdaptation);
      const bonusEntities = await this.generateBonusEntities(request, coreEntities);
      const _locationMappings = await this.generateLocationMappings(coreEntities, bonusEntities);
      
      // Phase 3: æœ€çµ‚èª¿æ•´
      logger.info('âš–ï¸ Phase 3: æœ€çµ‚èª¿æ•´é–‹å§‹');
      const detailedMilestones = await this.detailizeMilestones(milestoneOutlines, coreEntities);
      const balancedSystem = await this.balanceSystem(detailedMilestones, coreEntities, bonusEntities);
      
      // ä¸€æ‹¬ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚³ãƒŸãƒƒãƒˆ
      const commitResult = await this.commitToDatabase(balancedSystem);

      const processingTime = Date.now() - startTime;
      
      const response: MilestoneGenerationResponse = {
        milestones: commitResult.milestones,
        entityPool: commitResult.entityPool,
        themeAdaptation: commitResult.themeAdaptation,
        generationMetadata: {
          model: 'gemini-2.0-flash-lite', // ç¾åœ¨ä½¿ç”¨ä¸­ã®ãƒ¢ãƒ‡ãƒ«
          prompt: 'AI milestone top-down generation', 
          tokensUsed: 0, // TODO: ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’è¨˜éŒ²
          processingTime,
          generatedAt: new Date().toISOString()
        }
      };

      // ç”Ÿæˆå±¥æ­´ã‚’ä¿å­˜
      try {
        await this.saveGenerationHistory(request, response);
        logger.debug('âœ… ç”Ÿæˆå±¥æ­´ä¿å­˜å®Œäº†');
      } catch (historyError) {
        logger.warn('âš ï¸ ç”Ÿæˆå±¥æ­´ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒ¡ã‚¤ãƒ³ã®ç”Ÿæˆå‡¦ç†ã¯æˆåŠŸã—ã¾ã—ãŸ', { 
          error: historyError 
        });
      }

      logger.info('âœ… AI ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç”Ÿæˆå®Œäº†ï¼ˆãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼‰', { 
        milestonesCount: response.milestones.length,
        processingTime 
      });

      return response;

    } catch (error) {
      logger.error('âŒ AI ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç”Ÿæˆã‚¨ãƒ©ãƒ¼', { error });
      throw new AIServiceError('Failed to generate milestones and pools', 'milestone-generation');
    }
  }

  /**
   * ãƒ†ãƒ¼ãƒé©å¿œã®ç”Ÿæˆ
   */
  private async generateThemeAdaptation(themeId: ID, sessionConfig: SessionDurationConfig): Promise<ThemeAdaptation> {
    const aiService = getAIService();
    const provider = process.env.DEFAULT_AI_PROVIDER || 'google';
    
    try {
      const campaignContext = { themeId, sessionDuration: sessionConfig };
      
      const result = await aiService.performThemeAdaptation({
        provider,
        themeId,
        campaignContext,
        sessionDuration: sessionConfig,
      });

      // AIç”Ÿæˆçµæœã‚’è§£æ
      const generatedAdaptation = result.generatedThemeAdaptation;
      
      if (generatedAdaptation && typeof generatedAdaptation === 'object' && !generatedAdaptation.rawData) {
        logger.info('âœ… AI ãƒ†ãƒ¼ãƒé©å¿œç”ŸæˆæˆåŠŸ', { themeId, provider });
        return this.validateAndFormatThemeAdaptation(generatedAdaptation, themeId);
      }

      // AIç”Ÿæˆã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      logger.warn('âš ï¸ AI ãƒ†ãƒ¼ãƒé©å¿œç”Ÿæˆå¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ', { themeId });
      return this.createFallbackThemeAdaptation(themeId);

    } catch (error) {
      logger.error('âŒ AI ãƒ†ãƒ¼ãƒé©å¿œç”Ÿæˆã‚¨ãƒ©ãƒ¼', { error, themeId });
      return this.createFallbackThemeAdaptation(themeId);
    }
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ãƒ¼ãƒé©å¿œç”Ÿæˆ
   */
  private createFallbackThemeAdaptation(themeId: ID): ThemeAdaptation {
    const ispeacefulTheme = themeId.includes('peaceful') || themeId.includes('daily');
    
    return {
      themeId,
      allowedEntityTypes: ispeacefulTheme 
        ? ['event', 'npc', 'item', 'quest'] 
        : ['enemy', 'event', 'npc', 'item', 'quest'],
      restrictedEntityTypes: ispeacefulTheme ? ['enemy'] : [],
      specializations: [
        {
          entityType: 'event',
          categories: ispeacefulTheme ? ['daily_life', 'social', 'crafting'] : ['combat', 'exploration', 'mystery'],
          examples: ispeacefulTheme ? ['æ–™ç†ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ', 'åœ°åŸŸç¥­ã‚Š', 'å‹äººã¨ã®ä¼šè©±'] : ['æ´çªŸæ¢ç´¢', 'æ•µã¨ã®é­é‡', 'è¬è§£ã'],
          generationHints: ispeacefulTheme ? ['å¹³å’Œçš„', 'å”åŠ›çš„', 'å‰µé€ çš„'] : ['æŒ‘æˆ¦çš„', 'æˆ¦ç•¥çš„', 'å†’é™ºçš„']
        }
      ],
      contentModifiers: [
        {
          type: 'tone',
          value: ispeacefulTheme ? 'peaceful' : 'adventurous',
          description: ispeacefulTheme ? 'å¹³å’Œã§ç©ã‚„ã‹ãªé›°å›²æ°—' : 'å†’é™ºçš„ã§æŒ‘æˆ¦çš„ãªé›°å›²æ°—'
        }
      ]
    };
  }

  /**
   * AIã§ç”Ÿæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒé©å¿œã‚’æ¤œè¨¼ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   */
  private validateAndFormatThemeAdaptation(aiThemeAdaptation: any, themeId: ID): ThemeAdaptation {
    logger.debug('ğŸ”§ AIãƒ†ãƒ¼ãƒé©å¿œãƒ‡ãƒ¼ã‚¿å¤‰æ›é–‹å§‹', { 
      themeId,
      hasContentAdaptationStrategy: !!aiThemeAdaptation.contentAdaptationStrategy,
      hasContentModifiers: !!aiThemeAdaptation.contentModifiers,
      topLevelKeys: Object.keys(aiThemeAdaptation)
    });

    // AIå¿œç­”ã‹ã‚‰å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡º
    const allowedEntityTypes = 
      aiThemeAdaptation.allowedEntityTypes ||
      aiThemeAdaptation.contentAdaptationStrategy?.allowedEntityTypes ||
      ['event', 'npc', 'item', 'quest'];

    const restrictedEntityTypes = 
      aiThemeAdaptation.restrictedEntityTypes ||
      aiThemeAdaptation.contentAdaptationStrategy?.restrictedEntityTypes ||
      [];

    const specializations = 
      aiThemeAdaptation.specializations ||
      aiThemeAdaptation.contentAdaptationStrategy?.specializations ||
      [{
        entityType: 'event',
        categories: ['mystery', 'horror'],
        examples: ['æ€ªå¥‡ç¾è±¡', 'è¬ã®ç™ºè¦‹'],
        generationHints: ['é›°å›²æ°—é‡è¦–', 'ç·Šå¼µæ„Ÿ']
      }];

    const contentModifiers = 
      aiThemeAdaptation.contentModifiers ||
      aiThemeAdaptation.contentAdaptationStrategy?.contentModifiers ||
      [{
        type: 'tone',
        value: 'mysterious',
        description: 'ç¥ç§˜çš„ã§ä¸å®‰ãªé›°å›²æ°—'
      }];

    const formattedThemeAdaptation: ThemeAdaptation = {
      themeId,
      allowedEntityTypes,
      restrictedEntityTypes,
      specializations,
      contentModifiers
    };

    logger.debug('âœ… AIãƒ†ãƒ¼ãƒé©å¿œãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Œäº†', {
      originalKeys: Object.keys(aiThemeAdaptation),
      formattedKeys: Object.keys(formattedThemeAdaptation),
      allowedEntityTypesCount: allowedEntityTypes.length,
      restrictedEntityTypesCount: restrictedEntityTypes.length,
      specializationsCount: specializations.length,
      contentModifiersCount: contentModifiers.length
    });

    return formattedThemeAdaptation;
  }

  /**
   * ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ã®ç”Ÿæˆ
   */
  private async generateEntityPool(
    request: MilestoneGenerationRequest, 
    themeAdaptation: ThemeAdaptation
  ): Promise<EntityPool> {
    logger.debug('ğŸ¯ generateEntityPool é–‹å§‹', { 
      campaignId: request.campaignId, 
      sessionId: request.sessionId,
      themeId: request.themeId 
    });
    
    const provider = process.env.DEFAULT_AI_PROVIDER || 'google';
    
    try {
      logger.debug('ğŸ”§ Getting AI service...');
      const aiService = getAIService();
      logger.debug('âœ… AI service obtained');
      const poolId = randomUUID();
      const now = new Date().toISOString();
      
      logger.debug('ğŸ”§ Preparing campaign context...');
      const campaignContext = { 
        campaignId: request.campaignId,
        sessionId: request.sessionId,
        themeId: request.themeId,
        existingContent: request.existingContent 
      };
      logger.debug('âœ… Campaign context prepared');

      // AIã‚’ä½¿ã£ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ã‚’ç”Ÿæˆ
      logger.debug('ğŸš€ AI ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆé–‹å§‹', { provider, campaignId: request.campaignId });
      const result = await aiService.generateEntityPool({
        provider,
        campaignContext,
        themeAdaptation,
        sessionDuration: request.sessionDuration,
      });

      // AIç”Ÿæˆçµæœã‚’è§£æ
      logger.debug('ğŸ” AI ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆçµæœ', { 
        resultKeys: Object.keys(result || {}),
        hasGeneratedPool: !!result?.generatedEntityPool,
        generatedPoolType: typeof result?.generatedEntityPool,
        generatedPoolKeys: result?.generatedEntityPool ? Object.keys(result.generatedEntityPool) : [],
        provider
      });
      
      const generatedPool = result.generatedEntityPool;
      
      if (generatedPool && typeof generatedPool === 'object' && !generatedPool.rawData) {
        logger.info('âœ… AI ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ç”ŸæˆæˆåŠŸ', { 
          campaignId: request.campaignId,
          sessionId: request.sessionId,
          provider 
        });
        
        // ç”Ÿæˆã•ã‚ŒãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ã‚’ãƒ©ãƒƒãƒ—
        return {
          id: poolId,
          campaignId: request.campaignId,
          sessionId: request.sessionId,
          themeId: request.themeId,
          entities: generatedPool as EntityPoolCollection,
          generatedAt: now,
          lastUpdated: now
        };
      }

      // AIç”Ÿæˆã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      logger.warn('âš ï¸ AI ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆå¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ', { 
        campaignId: request.campaignId 
      });
      return await this.createFallbackEntityPool(request, themeAdaptation);

    } catch (error) {
      logger.error('âŒ AI ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆã‚¨ãƒ©ãƒ¼', { 
        error, 
        campaignId: request.campaignId,
        errorMessage: error instanceof Error ? error.message : 'Unknown error',
        errorStack: error instanceof Error ? error.stack : undefined,
        provider 
      });
      return await this.createFallbackEntityPool(request, themeAdaptation);
    }
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆ
   */
  private async createFallbackEntityPool(
    request: MilestoneGenerationRequest, 
    themeAdaptation: ThemeAdaptation
  ): Promise<EntityPool> {
    const poolId = randomUUID();
    const now = new Date().toISOString();

    // ãƒ†ãƒ¼ãƒã«åŸºã¥ã„ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç”Ÿæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    const enemies = themeAdaptation.allowedEntityTypes.includes('enemy') 
      ? await this.generateEnemies(request, themeAdaptation) 
      : [];
    const events = await this.generateEvents(request, themeAdaptation);
    const npcs = await this.generateNPCs(request, themeAdaptation);
    const items = await this.generateItems(request, themeAdaptation);
    const quests = await this.generateQuests(request, themeAdaptation);

    const entities: EntityPoolCollection = {
      enemies,
      events,
      npcs,
      items,
      quests
    };

    return {
      id: poolId,
      campaignId: request.campaignId,
      sessionId: request.sessionId,
      themeId: request.themeId,
      entities,
      generatedAt: now,
      lastUpdated: now
    };
  }

  /**
   * ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®ç”Ÿæˆ
   */
  private async generateMilestones(
    request: MilestoneGenerationRequest,
    entityPool: EntityPool,
    themeAdaptation: ThemeAdaptation
  ): Promise<AIMilestone[]> {
    const aiService = getAIService();
    const provider = process.env.DEFAULT_AI_PROVIDER || 'google';

    try {
      const campaignContext = { 
        campaignId: request.campaignId,
        sessionId: request.sessionId,
        themeId: request.themeId,
        existingContent: request.existingContent 
      };

      // AIã‚’ä½¿ã£ã¦ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’ç”Ÿæˆ
      const result = await aiService.generateMilestones({
        provider,
        campaignContext,
        sessionDuration: request.sessionDuration,
        themeAdaptation,
        entityPool: entityPool.entities,
        milestoneCount: request.milestoneCount,
      });

      // AIç”Ÿæˆçµæœã‚’è§£æ
      const generatedMilestones = result.generatedMilestones;
      
      if (generatedMilestones && Array.isArray(generatedMilestones)) {
        logger.info('âœ… AI ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç”ŸæˆæˆåŠŸ', { 
          campaignId: request.campaignId,
          sessionId: request.sessionId,
          milestonesCount: generatedMilestones.length,
          provider 
        });
        
        // AIã§ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’æ­£ã—ã„å‹ã«å¤‰æ›
        return generatedMilestones.map((milestone: any) => this.validateAndFormatMilestone(milestone, request));
      }

      // AIç”Ÿæˆã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      logger.warn('âš ï¸ AI ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç”Ÿæˆå¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ', { 
        campaignId: request.campaignId 
      });
      return this.createFallbackMilestones(request, entityPool, themeAdaptation);

    } catch (error) {
      logger.error('âŒ AI ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç”Ÿæˆã‚¨ãƒ©ãƒ¼', { error, campaignId: request.campaignId });
      return this.createFallbackMilestones(request, entityPool, themeAdaptation);
    }
  }

  /**
   * AIã§ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’æ¤œè¨¼ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   */
  private validateAndFormatMilestone(aiMilestone: any, request: MilestoneGenerationRequest): AIMilestone {
    const now = new Date().toISOString();
    
    return {
      id: aiMilestone.id || randomUUID(),
      campaignId: request.campaignId,
      sessionId: request.sessionId,
      title: aiMilestone.title || 'AIç”Ÿæˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³',
      description: aiMilestone.description || 'AIã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³',
      type: aiMilestone.type || 'event_clear',
      targetId: aiMilestone.targetId || randomUUID(),
      targetDetails: aiMilestone.targetDetails || {
        entityType: 'event',
        entityId: aiMilestone.targetId || randomUUID(),
        specificConditions: {}
      },
      status: 'pending',
      progress: 0,
      requiredConditions: aiMilestone.requiredConditions || [],
      reward: aiMilestone.reward || {
        experiencePoints: 100,
        items: [],
        characterBenefits: {},
        storyProgression: `ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã€Œ${aiMilestone.title}ã€å®Œäº†`
      },
      createdAt: now
    };
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç”Ÿæˆ
   */
  private createFallbackMilestones(
    request: MilestoneGenerationRequest,
    entityPool: EntityPool,
    themeAdaptation: ThemeAdaptation
  ): AIMilestone[] {
    const milestones: AIMilestone[] = [];
    const now = new Date().toISOString();

    // åŸºæœ¬3å€‹ç¨‹åº¦ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’ç”Ÿæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    const milestoneCount = Math.min(request.milestoneCount, 5); // æœ€å¤§5å€‹ã«åˆ¶é™

    for (let i = 0; i < milestoneCount; i++) {
      const milestoneType = this.selectMilestoneType(themeAdaptation);
      const targetEntity = this.selectTargetEntity(milestoneType, entityPool);
      
      if (!targetEntity) continue; // å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

      const milestone: AIMilestone = {
        id: randomUUID(),
        campaignId: request.campaignId,
        sessionId: request.sessionId,
        title: this.generateMilestoneTitle(milestoneType, targetEntity),
        description: this.generateMilestoneDescription(milestoneType, targetEntity),
        type: milestoneType,
        targetId: targetEntity.id,
        targetDetails: {
          entityType: this.getEntityTypeFromMilestoneType(milestoneType),
          entityId: targetEntity.id,
          specificConditions: this.generateSpecificConditions(milestoneType, targetEntity)
        },
        status: 'pending',
        progress: 0,
        requiredConditions: [],
        reward: {
          experiencePoints: this.calculateExperienceReward(milestoneType),
          items: [],
          characterBenefits: {},
          storyProgression: `ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã€Œ${this.generateMilestoneTitle(milestoneType, targetEntity)}ã€å®Œäº†`
        },
        createdAt: now
      };

      // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ•ãƒ©ã‚°ã‚’è¨­å®š
      this.markEntityAsMilestoneTarget(targetEntity, entityPool);

      milestones.push(milestone);
    }

    return milestones;
  }

  /**
   * ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã®é¸æŠï¼ˆãƒ†ãƒ¼ãƒé©å¿œï¼‰
   */
  private selectMilestoneType(themeAdaptation: ThemeAdaptation): MilestoneType {
    const availableTypes: MilestoneType[] = [];

    if (themeAdaptation.allowedEntityTypes.includes('enemy')) {
      availableTypes.push('enemy_defeat');
    }
    if (themeAdaptation.allowedEntityTypes.includes('event')) {
      availableTypes.push('event_clear');
    }
    if (themeAdaptation.allowedEntityTypes.includes('npc')) {
      availableTypes.push('npc_communication');
    }
    if (themeAdaptation.allowedEntityTypes.includes('item')) {
      availableTypes.push('item_acquisition');
    }
    if (themeAdaptation.allowedEntityTypes.includes('quest')) {
      availableTypes.push('quest_completion');
    }

    // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
    return availableTypes[Math.floor(Math.random() * availableTypes.length)];
  }

  /**
   * å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®é¸æŠ
   */
  private selectTargetEntity(milestoneType: MilestoneType, entityPool: EntityPool): any | null {
    const entities = entityPool.entities;

    switch (milestoneType) {
      case 'enemy_defeat':
        return entities.enemies.length > 0 ? entities.enemies[Math.floor(Math.random() * entities.enemies.length)] : null;
      case 'event_clear':
        return entities.events.length > 0 ? entities.events[Math.floor(Math.random() * entities.events.length)] : null;
      case 'npc_communication':
        return entities.npcs.length > 0 ? entities.npcs[Math.floor(Math.random() * entities.npcs.length)] : null;
      case 'item_acquisition':
        return entities.items.length > 0 ? entities.items[Math.floor(Math.random() * entities.items.length)] : null;
      case 'quest_completion':
        return entities.quests.length > 0 ? entities.quests[Math.floor(Math.random() * entities.quests.length)] : null;
      default:
        return null;
    }
  }

  /**
   * ã‚¨ãƒãƒŸãƒ¼ç”Ÿæˆï¼ˆä»®å®Ÿè£…ï¼‰
   */
  private async generateEnemies(_request: MilestoneGenerationRequest, _themeAdaptation: ThemeAdaptation): Promise<PoolEnemy[]> {
    // TODO: AIã‚’ä½¿ã£ã¦å®Ÿéš›ã®ã‚¨ãƒãƒŸãƒ¼ã‚’ç”Ÿæˆ
    return [
      {
        id: randomUUID(),
        name: 'ã‚´ãƒ–ãƒªãƒ³',
        description: 'å°æŸ„ã§ç‹¡çŒ¾ãªç·‘è‰²ã®æ€ªç‰©',
        level: 1,
        abilities: {
          hitPoints: 20,
          attackPower: 5,
          defense: 2,
          specialAbilities: ['ç´ æ—©ã„ç§»å‹•'],
          weaknesses: ['å…‰é­”æ³•'],
          resistances: ['æ¯’']
        },
        locationIds: [],
        isMilestoneTarget: false,
        rewards: [
          {
            type: 'experience',
            value: 50,
            description: 'ã‚´ãƒ–ãƒªãƒ³è¨ä¼ã®çµŒé¨“å€¤'
          }
        ],
        behavior: {
          aggression: 6,
          intelligence: 4,
          preferredTactics: ['ç¾¤ã‚Œã§ã®æ”»æ’ƒ', 'ç½ ã®ä½¿ç”¨'],
          combatDialogue: ['ã‚°ãƒ«ãƒ«ãƒ«ãƒ«ï¼', 'ã‚­ã‚£ã‚£ã‚£ï¼']
        }
      }
    ];
  }

  /**
   * ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆï¼ˆä»®å®Ÿè£…ï¼‰
   */
  private async generateEvents(_request: MilestoneGenerationRequest, _themeAdaptation: ThemeAdaptation): Promise<InteractiveEvent[]> {
    // TODO: AIã‚’ä½¿ã£ã¦å®Ÿéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”Ÿæˆ
    return [
      {
        id: randomUUID(),
        name: 'å¤ã„æ´çªŸã®æ¢ç´¢',
        description: 'æ‘ã®å¤–ã‚Œã«ã‚ã‚‹å¤ã„æ´çªŸã‹ã‚‰ä¸æ€è­°ãªå…‰ãŒæ¼ã‚Œã¦ã„ã‚‹',
        locationIds: [],
        choices: [
          {
            id: randomUUID(),
            text: 'æ´çªŸã«å…¥ã‚‹',
            description: 'å‹‡æ°—ã‚’å‡ºã—ã¦æ´çªŸã®ä¸­ã‚’èª¿ã¹ã‚‹',
            requirements: [],
            consequences: []
          },
          {
            id: randomUUID(),
            text: 'æ‘äººã«ç›¸è«‡ã™ã‚‹',
            description: 'ä¸€æ—¦æ‘ã«æˆ»ã£ã¦æƒ…å ±ã‚’é›†ã‚ã‚‹',
            requirements: [],
            consequences: []
          }
        ],
        isMilestoneTarget: false,
        requiredConditions: [],
        outcomes: []
      }
    ];
  }

  /**
   * NPCç”Ÿæˆï¼ˆä»®å®Ÿè£…ï¼‰
   */
  private async generateNPCs(_request: MilestoneGenerationRequest, _themeAdaptation: ThemeAdaptation): Promise<PoolNPC[]> {
    // TODO: AIã‚’ä½¿ã£ã¦å®Ÿéš›ã®NPCã‚’ç”Ÿæˆ
    return [
      {
        id: randomUUID(),
        name: 'è³¢è€…ã‚¨ãƒ«ã‚¦ã‚£ãƒ³',
        description: 'å¤ã„çŸ¥è­˜ã«è©³ã—ã„æ‘ã®é•·è€',
        personality: {
          traits: ['çŸ¥è­˜è±Šå¯Œ', 'æ…é‡', 'è¦ªåˆ‡'],
          goals: ['æ‘ã®å¹³å’Œ', 'çŸ¥è­˜ã®ç¶™æ‰¿'],
          fears: ['å¤ä»£ã®å°å°ãŒè§£ã‹ã‚Œã‚‹ã“ã¨'],
          motivations: ['è‹¥ã„ä¸–ä»£ã®æˆé•·']
        },
        locationIds: [],
        dialoguePatterns: [
          {
            trigger: 'greeting',
            responses: ['ã“ã‚“ã«ã¡ã¯ã€è‹¥è€…ã‚ˆ', 'ãŠç–²ã‚Œã®ã‚ˆã†ã˜ã‚ƒã®'],
            mood: 'friendly'
          }
        ],
        communicationConditions: [
          {
            type: 'greeting',
            requiredRelationship: 0,
            availableResponses: ['å¤ã„ä¼èª¬ã«ã¤ã„ã¦æ•™ãˆã¦', 'æ‘ã®æ­´å²ã‚’èã']
          }
        ],
        isMilestoneTarget: false,
        relationshipLevel: 0
      }
    ];
  }

  /**
   * ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆï¼ˆä»®å®Ÿè£…ï¼‰
   */
  private async generateItems(_request: MilestoneGenerationRequest, _themeAdaptation: ThemeAdaptation): Promise<PoolItem[]> {
    // TODO: AIã‚’ä½¿ã£ã¦å®Ÿéš›ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”Ÿæˆ
    return [
      {
        id: randomUUID(),
        name: 'å¤ä»£ã®å·»ç‰©',
        description: 'å¤ä»£æ–‡å­—ã§æ›¸ã‹ã‚ŒãŸè¬ã‚ã„ãŸå·»ç‰©',
        type: 'key_item',
        rarity: 'rare',
        effects: [
          {
            type: 'special',
            magnitude: 0,
            description: 'å¤ä»£ã®çŸ¥è­˜ã‚’è§£èª­ã§ãã‚‹'
          }
        ],
        acquisitionMethods: [
          {
            type: 'exploration',
            sourceId: randomUUID(),
            probability: 0.3,
            conditions: ['æ´çªŸã®æ¢ç´¢']
          }
        ],
        isMilestoneTarget: false,
        value: 1000
      }
    ];
  }

  /**
   * ã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆï¼ˆä»®å®Ÿè£…ï¼‰
   */
  private async generateQuests(_request: MilestoneGenerationRequest, _themeAdaptation: ThemeAdaptation): Promise<PoolQuest[]> {
    // TODO: AIã‚’ä½¿ã£ã¦å®Ÿéš›ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’ç”Ÿæˆ
    return [
      {
        id: randomUUID(),
        title: 'å¤±ã‚ã‚ŒãŸæ‘ã®ç§˜å®',
        description: 'æ‘ã«ä»£ã€…ä¼ã‚ã‚‹ç§˜å®ãŒç›—ã¾ã‚Œã¦ã—ã¾ã£ãŸã€‚çŠ¯äººã‚’è¦‹ã¤ã‘ã¦ç§˜å®ã‚’å–ã‚Šæˆ»ã›ã€‚',
        type: 'main',
        objectives: [
          {
            id: randomUUID(),
            description: 'æ‰‹ãŒã‹ã‚Šã‚’æ¢ã™',
            completed: false,
            optional: false,
            progress: 0,
            requirements: []
          }
        ],
        rewards: {
          experience: 200,
          currency: 500,
          items: [],
          storyProgression: ['æ‘ã®ä¿¡é ¼ã‚’å¾—ã‚‹'],
          relationshipChanges: {}
        },
        difficulty: 'medium',
        estimatedTime: 120,
        prerequisites: [],
        isMilestoneTarget: false
      }
    ];
  }

  /**
   * ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
   */
  private generateMilestoneTitle(type: MilestoneType, entity: any): string {
    switch (type) {
      case 'enemy_defeat':
        return `${entity.name}ã®è¨ä¼`;
      case 'event_clear':
        return `${entity.name}ã®ã‚¯ãƒªã‚¢`;
      case 'npc_communication':
        return `${entity.name}ã¨ã®å¯¾è©±`;
      case 'item_acquisition':
        return `${entity.name}ã®å–å¾—`;
      case 'quest_completion':
        return `${entity.title}ã®å®Œäº†`;
      default:
        return 'ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³';
    }
  }

  /**
   * ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³èª¬æ˜ç”Ÿæˆ
   */
  private generateMilestoneDescription(type: MilestoneType, entity: any): string {
    switch (type) {
      case 'enemy_defeat':
        return `${entity.name}ã‚’å€’ã—ã¦ãã ã•ã„ã€‚${entity.description}`;
      case 'event_clear':
        return `${entity.name}ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚${entity.description}`;
      case 'npc_communication':
        return `${entity.name}ã¨é‡è¦ãªä¼šè©±ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚${entity.description}`;
      case 'item_acquisition':
        return `${entity.name}ã‚’å…¥æ‰‹ã—ã¦ãã ã•ã„ã€‚${entity.description}`;
      case 'quest_completion':
        return `ã‚¯ã‚¨ã‚¹ãƒˆã€Œ${entity.title}ã€ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚${entity.description}`;
      default:
        return 'ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’é”æˆã—ã¦ãã ã•ã„ã€‚';
    }
  }

  /**
   * ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—å–å¾—
   */
  private getEntityTypeFromMilestoneType(type: MilestoneType): 'enemy' | 'event' | 'npc' | 'item' | 'quest' {
    switch (type) {
      case 'enemy_defeat': return 'enemy';
      case 'event_clear': return 'event';
      case 'npc_communication': return 'npc';
      case 'item_acquisition': return 'item';
      case 'quest_completion': return 'quest';
      default: return 'event'; // fallback
    }
  }

  /**
   * ç‰¹å®šæ¡ä»¶ç”Ÿæˆ
   */
  private generateSpecificConditions(type: MilestoneType, _entity: any): Record<string, any> {
    switch (type) {
      case 'npc_communication':
        return { requiredTopics: ['é‡è¦ãªæƒ…å ±', 'æ‘ã®æ­´å²'] };
      case 'item_acquisition':
        return { requiredQuantity: 1 };
      default:
        return {};
    }
  }

  /**
   * çµŒé¨“å€¤å ±é…¬è¨ˆç®—
   */
  private calculateExperienceReward(type: MilestoneType): number {
    const baseRewards: Record<MilestoneType, number> = {
      enemy_defeat: 100,
      event_clear: 75,
      npc_communication: 50,
      item_acquisition: 60,
      quest_completion: 150
    };
    
    return baseRewards[type] || 50;
  }

  /**
   * ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦ãƒãƒ¼ã‚¯
   */
  private markEntityAsMilestoneTarget(entity: any, _entityPool: EntityPool): void {
    if (entity && typeof entity === 'object' && 'isMilestoneTarget' in entity) {
      entity.isMilestoneTarget = true;
    }
  }

  /**
   * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜
   */
  private async saveMilestonesAndPools(
    milestones: AIMilestone[], 
    entityPool: EntityPool, 
    themeAdaptation: ThemeAdaptation
  ): Promise<void> {
    logger.debug('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜é–‹å§‹', { 
      milestonesCount: milestones.length,
      entityPoolId: entityPool.id,
      themeId: themeAdaptation.themeId 
    });

    try {
      // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’ä¿å­˜
      logger.debug('ğŸ’¾ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä¿å­˜é–‹å§‹');
      const milestoneStmt = this.db.prepare(`
        INSERT OR REPLACE INTO ai_milestones (
          id, campaign_id, session_id, title, description, type, target_id,
          target_details, status, progress, required_conditions, reward, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `);

      for (let i = 0; i < milestones.length; i++) {
        const milestone = milestones[i];
        
        // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è©³ç´°ãªå€¤ãƒã‚§ãƒƒã‚¯
        const targetDetailsStr = JSON.stringify(milestone.targetDetails);
        const requiredConditionsStr = JSON.stringify(milestone.requiredConditions);
        const rewardStr = JSON.stringify(milestone.reward);
        
        logger.debug(`ğŸ’¾ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ ${i + 1} ä¿å­˜è©³ç´°`, {
          id: milestone.id,
          title: milestone.title,
          allFieldValues: {
            id: milestone.id,
            campaignId: milestone.campaignId,
            sessionId: milestone.sessionId,
            title: milestone.title,
            description: milestone.description,
            type: milestone.type,
            targetId: milestone.targetId,
            targetDetailsStr: targetDetailsStr,
            status: milestone.status,
            progress: milestone.progress,
            requiredConditionsStr: requiredConditionsStr,
            rewardStr: rewardStr,
            createdAt: milestone.createdAt
          },
          hasNullValues: {
            id: milestone.id == null,
            campaignId: milestone.campaignId == null,
            sessionId: milestone.sessionId == null,
            title: milestone.title == null,
            description: milestone.description == null,
            type: milestone.type == null,
            targetId: milestone.targetId == null,
            targetDetailsStr: targetDetailsStr == null,
            status: milestone.status == null,
            progress: milestone.progress == null,
            requiredConditionsStr: requiredConditionsStr == null,
            rewardStr: rewardStr == null,
            createdAt: milestone.createdAt == null
          }
        });

        try {
          milestoneStmt.run([
            milestone.id,
            milestone.campaignId,
            milestone.sessionId,
            milestone.title,
            milestone.description,
            milestone.type,
            milestone.targetId,
            targetDetailsStr,
            milestone.status,
            milestone.progress,
            requiredConditionsStr,
            rewardStr,
            milestone.createdAt
          ]);
          logger.debug(`âœ… ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ ${i + 1} ä¿å­˜æˆåŠŸ`);
        } catch (error) {
          logger.error(`âŒ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ ${i + 1} ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°`, { 
            error, 
            errorMessage: error instanceof Error ? error.message : 'Unknown error',
            milestone: {
              id: milestone.id,
              title: milestone.title,
              fields: [
                milestone.id,
                milestone.campaignId,
                milestone.sessionId,
                milestone.title,
                milestone.description,
                milestone.type,
                milestone.targetId,
                targetDetailsStr,
                milestone.status,
                milestone.progress,
                requiredConditionsStr,
                rewardStr,
                milestone.createdAt
              ]
            }
          });
          throw error;
        }
      }
      logger.debug('âœ… ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä¿å­˜å®Œäº†');
    } catch (error) {
      logger.error('âŒ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼', { error });
      throw error;
    }

    try {
      // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ã‚’ä¿å­˜
      logger.debug('ğŸ’¾ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ä¿å­˜é–‹å§‹', {
        entityPoolData: {
          id: entityPool.id,
          campaignId: entityPool.campaignId,
          sessionId: entityPool.sessionId,
          themeId: entityPool.themeId,
          hasNullValues: {
            id: entityPool.id == null,
            campaignId: entityPool.campaignId == null,
            sessionId: entityPool.sessionId == null,
            themeId: entityPool.themeId == null,
            entities: entityPool.entities == null,
            generatedAt: entityPool.generatedAt == null,
            lastUpdated: entityPool.lastUpdated == null
          }
        }
      });

      const poolStmt = this.db.prepare(`
        INSERT OR REPLACE INTO entity_pools (
          id, campaign_id, session_id, theme_id, entities, generated_at, last_updated
        ) VALUES (?, ?, ?, ?, ?, ?, ?)
      `);

      poolStmt.run([
        entityPool.id,
        entityPool.campaignId,
        entityPool.sessionId,
        entityPool.themeId,
        JSON.stringify(entityPool.entities),
        entityPool.generatedAt,
        entityPool.lastUpdated
      ]);
      logger.debug('âœ… ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ä¿å­˜å®Œäº†');
    } catch (error) {
      logger.error('âŒ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼', { error, entityPool });
      throw error;
    }

    try {
      // ãƒ†ãƒ¼ãƒé©å¿œã‚’ä¿å­˜
      logger.debug('ğŸ’¾ ãƒ†ãƒ¼ãƒé©å¿œä¿å­˜é–‹å§‹', {
        themeAdaptationData: {
          themeId: themeAdaptation.themeId,
          hasNullValues: {
            themeId: themeAdaptation.themeId == null,
            allowedEntityTypes: themeAdaptation.allowedEntityTypes == null,
            restrictedEntityTypes: themeAdaptation.restrictedEntityTypes == null,
            specializations: themeAdaptation.specializations == null,
            contentModifiers: themeAdaptation.contentModifiers == null
          }
        }
      });

      const themeStmt = this.db.prepare(`
        INSERT OR REPLACE INTO theme_adaptations (
          id, theme_id, allowed_entity_types, restricted_entity_types,
          specializations, content_modifiers, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?)
      `);

      themeStmt.run([
        randomUUID(),
        themeAdaptation.themeId,
        JSON.stringify(themeAdaptation.allowedEntityTypes),
        JSON.stringify(themeAdaptation.restrictedEntityTypes),
        JSON.stringify(themeAdaptation.specializations),
        JSON.stringify(themeAdaptation.contentModifiers),
        new Date().toISOString()
      ]);
      logger.debug('âœ… ãƒ†ãƒ¼ãƒé©å¿œä¿å­˜å®Œäº†');
    } catch (error) {
      logger.error('âŒ ãƒ†ãƒ¼ãƒé©å¿œä¿å­˜ã‚¨ãƒ©ãƒ¼', { error, themeAdaptation });
      throw error;
    }

    logger.debug('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜å®Œäº†');
  }

  /**
   * ç”Ÿæˆå±¥æ­´ã®ä¿å­˜
   */
  private async saveGenerationHistory(
    request: MilestoneGenerationRequest,
    response: MilestoneGenerationResponse
  ): Promise<void> {
    const stmt = this.db.prepare(`
      INSERT INTO milestone_generation_history (
        id, campaign_id, session_id, generation_metadata, generated_at
      ) VALUES (?, ?, ?, ?, ?)
    `);

    stmt.run([
      randomUUID(),
      request.campaignId,
      request.sessionId,
      JSON.stringify(response.generationMetadata),
      response.generationMetadata.generatedAt
    ]);
  }

  /**
   * ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å–å¾—
   */
  async getAIMilestonesByCampaign(campaignId: ID): Promise<AIMilestone[]> {
    const stmt = this.db.prepare(`
      SELECT * FROM ai_milestones 
      WHERE campaign_id = ? 
      ORDER BY created_at ASC
    `);
    
    const rows = stmt.all(campaignId) as any[];
    
    return rows.map((row): AIMilestone => ({
      id: row.id,
      campaignId: row.campaign_id,
      sessionId: row.session_id,
      title: row.title,
      description: row.description,
      type: row.type,
      targetId: row.target_id,
      targetDetails: JSON.parse(row.target_details),
      status: row.status,
      progress: row.progress,
      requiredConditions: JSON.parse(row.required_conditions),
      reward: JSON.parse(row.reward),
      createdAt: row.created_at,
      completedAt: row.completed_at
    }));
  }

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«å–å¾—
   */
  async getEntityPoolBySession(sessionId: ID): Promise<EntityPool | null> {
    const stmt = this.db.prepare('SELECT * FROM entity_pools WHERE session_id = ?');
    const row = stmt.get(sessionId) as any;
    
    if (!row) return null;

    return {
      id: row.id,
      campaignId: row.campaign_id,
      sessionId: row.session_id,
      themeId: row.theme_id,
      entities: JSON.parse(row.entities),
      generatedAt: row.generated_at,
      lastUpdated: row.last_updated
    };
  }

  /**
   * ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é€²æ—æ›´æ–°
   */
  async updateMilestoneProgress(milestoneId: ID, progress: number, status?: 'pending' | 'in_progress' | 'completed'): Promise<void> {
    const updates: string[] = ['progress = ?'];
    const values: any[] = [progress];

    if (status) {
      updates.push('status = ?');
      values.push(status);
      
      if (status === 'completed') {
        updates.push('completed_at = ?');
        values.push(new Date().toISOString());
      }
    }

    values.push(milestoneId);

    const stmt = this.db.prepare(`
      UPDATE ai_milestones SET ${updates.join(', ')} WHERE id = ?
    `);

    stmt.run(values);
  }

  /**
   * ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å‰Šé™¤
   */
  async deleteAIMilestone(milestoneId: ID): Promise<void> {
    const stmt = this.db.prepare(`
      DELETE FROM ai_milestones WHERE id = ?
    `);

    const result = stmt.run(milestoneId);
    
    if (result.changes === 0) {
      throw new Error(`Milestone with ID ${milestoneId} not found`);
    }

    logger.info('âœ… ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å‰Šé™¤æˆåŠŸ', { 
      milestoneId,
      deletedRows: result.changes 
    });
  }

  // =============================================================================
  // ãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå®Ÿè£…ãƒ¡ã‚½ãƒƒãƒ‰ç¾¤
  // =============================================================================

  /**
   * Phase 1: ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ¦‚è¦ç”Ÿæˆ
   * ãƒ†ãƒ¼ãƒã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã«åŸºã¥ã„ã¦åŸºæœ¬çš„ãªãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ§‹é€ ã‚’ç”Ÿæˆ
   */
  private async generateMilestoneOutlines(
    request: MilestoneGenerationRequest,
    themeAdaptation: ThemeAdaptation
  ): Promise<any[]> {
    logger.info('ğŸ“‹ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ¦‚è¦ç”Ÿæˆé–‹å§‹', { milestoneCount: request.milestoneCount });

    const aiService = getAIService();
    
    // ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã®åˆ¶é™
    const allowedTypes = ['ç‰¹å®šã‚¨ãƒãƒŸãƒ¼è¨ä¼', 'ç‰¹å®šã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªã‚¢', 'ç‰¹å®šNPCã¨ã®ç‰¹å®šã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'ã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ å–å¾—', 'ã‚¯ã‚¨ã‚¹ãƒˆã‚¯ãƒªã‚¢'];
    const restrictedTypes = themeAdaptation.restrictedEntityTypes || [];
    const availableTypes = allowedTypes.filter(type => !restrictedTypes.includes(type));

    const prompt = `
ä»¥ä¸‹ã®æ¡ä»¶ã§TRPGãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®æ¦‚è¦ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

**åŸºæœ¬è¨­å®š:**
- ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“: ${request.sessionDuration?.estimatedPlayTime || 60}åˆ†
- ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ•°: ${request.milestoneCount || 3}å€‹
- ãƒ†ãƒ¼ãƒ: ${request.themeId}
- åˆ©ç”¨å¯èƒ½ãªãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—: ${availableTypes.join(', ')}

**ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ¦‚è¦è¦ä»¶:**
1. å„ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã¯3ã¤ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§æ§‹æˆã•ã‚Œã‚‹
2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¯é€²æ—ã‚’ç›´æ¥è¡¨ç¤ºã—ãªã„ï¼ˆæ‰‹æ¢ã‚Šæ„Ÿé‡è¦–ï¼‰
3. ç‰©èªçš„ãªä¸€è²«æ€§ã‚’ä¿ã¤
4. é›£æ˜“åº¦ã¯æ®µéšçš„ã«ä¸Šæ˜‡

**å‡ºåŠ›å½¢å¼:**
[
  {
    "id": "milestone-1",
    "title": "è¬ã®äº‹ä»¶ã®ç™ºç«¯",
    "description": "æ‘ã§èµ·ã“ã£ãŸä¸å¯è§£ãªäº‹ä»¶ã®çœŸç›¸ã«è¿«ã‚‹æœ€åˆã®æ‰‹ãŒã‹ã‚Šã‚’è¦‹ã¤ã‘ã‚‹",
    "type": "ç‰¹å®šã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªã‚¢",
    "estimatedDuration": 20,
    "storyPosition": "beginning",
    "requiredEntityCount": 3
  }
]
`;

    try {
      const response = await aiService.chat({
        provider: 'google',
        apiKey: process.env.GOOGLE_API_KEY || '',
        message: prompt,
        persona: 'trpg_scenario_expert'
      });
      const milestoneOutlines = JSON.parse(response.message);
      
      logger.info('âœ… ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ¦‚è¦ç”Ÿæˆå®Œäº†', { 
        count: milestoneOutlines.length,
        types: milestoneOutlines.map((m: any) => m.type)
      });
      
      return milestoneOutlines;
    } catch (error) {
      logger.error('âŒ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ¦‚è¦ç”Ÿæˆå¤±æ•—', { error });
      throw new AIServiceError('ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ¦‚è¦ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'MILESTONE_OUTLINE_GENERATION_FAILED');
    }
  }

  /**
   * Phase 1: ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é–¢ä¿‚æ€§è¨­å®š
   * ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é–“ã®ä¾å­˜é–¢ä¿‚ã¨é€²è¡Œé †åºã‚’å®šç¾©
   */
  private async defineMilestoneRelations(
    milestoneOutlines: any[]
  ): Promise<any[]> {
    logger.info('ğŸ”— ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é–¢ä¿‚æ€§è¨­å®šé–‹å§‹');

    const aiService = getAIService();
    
    const prompt = `
ä»¥ä¸‹ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ¦‚è¦ã«å¯¾ã—ã¦ã€é–¢ä¿‚æ€§ã¨ä¾å­˜é–¢ä¿‚ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š

**ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ¦‚è¦:**
${JSON.stringify(milestoneOutlines, null, 2)}

**é–¢ä¿‚æ€§è¨­å®šè¦ä»¶:**
1. ç‰©èªã®æµã‚Œã«æ²¿ã£ãŸé †åºè¨­å®š
2. å‰ææ¡ä»¶ã®æ˜ç¢ºåŒ–
3. ä¸¦è¡Œå®Ÿè¡Œå¯èƒ½ãªãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®ç‰¹å®š
4. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‡ªç”±åº¦ã‚’ä¿ã¤ãƒãƒ©ãƒ³ã‚¹

**å‡ºåŠ›å½¢å¼:**
[
  {
    "milestoneId": "milestone-1",
    "prerequisites": [],
    "unlocks": ["milestone-2"],
    "canParallelWith": [],
    "storyWeight": 1.0,
    "progressContribution": 33.33
  }
]
`;

    try {
      const response = await aiService.chat({
        provider: 'google',
        apiKey: process.env.GOOGLE_API_KEY || '',
        message: prompt,
        persona: 'trpg_scenario_expert'
      });
      const milestoneRelations = JSON.parse(response.message);
      
      logger.info('âœ… ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é–¢ä¿‚æ€§è¨­å®šå®Œäº†', { 
        relationCount: milestoneRelations.length
      });
      
      return milestoneRelations;
    } catch (error) {
      logger.error('âŒ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é–¢ä¿‚æ€§è¨­å®šå¤±æ•—', { error });
      throw new AIServiceError('ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é–¢ä¿‚æ€§è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ', 'MILESTONE_RELATIONS_FAILED');
    }
  }

  /**
   * Phase 2: ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¦ä»¶æ±ºå®š
   * å„ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã«å¿…è¦ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è¦ä»¶ã‚’å®šç¾©
   */
  private async defineCoreEntityRequirements(
    milestoneRelations: any[],
    themeAdaptation: ThemeAdaptation
  ): Promise<any> {
    logger.info('ğŸ¯ ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¦ä»¶æ±ºå®šé–‹å§‹');

    const aiService = getAIService();
    
    const prompt = `
ä»¥ä¸‹ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é–¢ä¿‚æ€§ã«åŸºã¥ã„ã¦ã€å¿…è¦ãªã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è¦ä»¶ã‚’æ±ºå®šã—ã¦ãã ã•ã„ï¼š

**ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é–¢ä¿‚æ€§:**
${JSON.stringify(milestoneRelations, null, 2)}

**ãƒ†ãƒ¼ãƒåˆ¶ç´„:**
- è¨±å¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—: ${themeAdaptation.allowedEntityTypes.join(', ')}
- åˆ¶é™ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—: ${themeAdaptation.restrictedEntityTypes.join(', ')}
- ç‰¹æ®ŠåŒ–è¦ç´ : ${themeAdaptation.specializations.join(', ')}

**è¦ä»¶æ±ºå®šæ¡ä»¶:**
1. å„ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã«3ã¤ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’é…ç½®
2. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã®ãƒãƒ©ãƒ³ã‚¹ï¼ˆenemies, events, npcs, items, questsï¼‰
3. é€²æ—è²¢çŒ®åº¦ã®è¨­å®šï¼ˆé€šå¸¸ã¯33%ãšã¤ï¼‰
4. ç‰©èªçš„æ•´åˆæ€§ã®ä¿æŒ

**å‡ºåŠ›å½¢å¼:**
{
  "milestone-1": {
    "entities": [
      {
        "type": "event",
        "role": "investigation_start",
        "progressContribution": 33,
        "requirements": "æ‘ã®ä¸­å¤®ã§èª¿æŸ»ã‚¤ãƒ™ãƒ³ãƒˆ"
      },
      {
        "type": "npc", 
        "role": "witness",
        "progressContribution": 33,
        "requirements": "ç›®æ’ƒè€…NPCã¨ã®å¯¾è©±"
      },
      {
        "type": "item",
        "role": "evidence",
        "progressContribution": 34,
        "requirements": "æ±ºå®šçš„è¨¼æ‹ ã‚¢ã‚¤ãƒ†ãƒ ã®ç™ºè¦‹"
      }
    ]
  }
}
`;

    try {
      const response = await aiService.chat({
        provider: 'google',
        apiKey: process.env.GOOGLE_API_KEY || '',
        message: prompt,
        persona: 'trpg_entity_designer'
      });
      const entityRequirements = JSON.parse(response.message);
      
      logger.info('âœ… ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¦ä»¶æ±ºå®šå®Œäº†', { 
        milestoneCount: Object.keys(entityRequirements).length
      });
      
      return entityRequirements;
    } catch (error) {
      logger.error('âŒ ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¦ä»¶æ±ºå®šå¤±æ•—', { error });
      throw new AIServiceError('ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¦ä»¶æ±ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ', 'CORE_ENTITY_REQUIREMENTS_FAILED');
    }
  }

  /**
   * Phase 2: ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆ
   * ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆã«å¿…é ˆã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç”Ÿæˆ
   */
  private async generateCoreEntities(
    entityRequirements: any,
    request: MilestoneGenerationRequest,
    themeAdaptation: ThemeAdaptation
  ): Promise<any> {
    logger.info('ğŸ² ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆé–‹å§‹');

    const aiService = getAIService();
    
    const prompt = `
ä»¥ä¸‹ã®è¦ä»¶ã«åŸºã¥ã„ã¦ã€ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

**ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¦ä»¶:**
${JSON.stringify(entityRequirements, null, 2)}

**ãƒ†ãƒ¼ãƒæƒ…å ±:**
- ãƒ†ãƒ¼ãƒID: ${request.themeId}
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¿®æ­£è¦ç´ : ${themeAdaptation.contentModifiers.join(', ')}

**ç”Ÿæˆæ¡ä»¶:**
1. å„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯æ˜ç¢ºãªç›®çš„ã‚’æŒã¤
2. é©åˆ‡ãªé›£æ˜“åº¦è¨­å®š
3. å ±é…¬è¨­å®šï¼ˆçµŒé¨“å€¤ã€ã‚¢ã‚¤ãƒ†ãƒ ã€æƒ…å ±ï¼‰
4. æ—¥æœ¬èªã§ã®è‡ªç„¶ãªè¡¨ç¾

**å‡ºåŠ›å½¢å¼:**
{
  "enemies": [
    {
      "id": "enemy-001",
      "name": "æ‘ã®çœŸçŠ¯äºº",
      "description": "äº‹ä»¶ã®çœŸç›¸ã‚’éš ãã†ã¨ã™ã‚‹è¬ã®äººç‰©",
      "level": 3,
      "milestoneId": "milestone-1",
      "progressContribution": 34,
      "rewards": {
        "experience": 80,
        "items": ["æ±ºå®šçš„è¨¼æ‹ "],
        "information": ["äº‹ä»¶ã®çœŸç›¸"]
      }
    }
  ],
  "events": [
    {
      "id": "event-001", 
      "name": "è¡€ç—•ã®èª¿æŸ»",
      "description": "ç¾å ´ã«æ®‹ã•ã‚ŒãŸè¡€ç—•ã‚’è©³ã—ãèª¿ã¹ã‚‹",
      "milestoneId": "milestone-1",
      "progressContribution": 33,
      "rewards": {
        "experience": 50,
        "information": ["çŠ¯äººã¯å·¦åˆ©ãã®å¯èƒ½æ€§"],
        "items": []
      }
    }
  ],
  "npcs": [
    {
      "id": "npc-001",
      "name": "ç›®æ’ƒè€…ã®æ‘äºº",
      "description": "äº‹ä»¶å½“å¤œã«æ€ªã—ã„äººå½±ã‚’è¦‹ãŸæ‘äºº",
      "milestoneId": "milestone-1", 
      "progressContribution": 33,
      "rewards": {
        "experience": 40,
        "information": ["äº‹ä»¶å½“å¤œã®æ€ªã—ã„äººå½±"],
        "relationships": [{"npcId": "witness-001", "change": 20}]
      }
    }
  ],
  "items": [],
  "quests": []
}
`;

    try {
      const response = await aiService.chat({
        provider: 'google',
        apiKey: process.env.GOOGLE_API_KEY || '',
        message: prompt,
        persona: 'trpg_entity_generator'
      });
      const coreEntities = JSON.parse(response.message);
      
      logger.info('âœ… ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆå®Œäº†', { 
        enemies: coreEntities.enemies?.length || 0,
        events: coreEntities.events?.length || 0,
        npcs: coreEntities.npcs?.length || 0,
        items: coreEntities.items?.length || 0,
        quests: coreEntities.quests?.length || 0
      });
      
      return coreEntities;
    } catch (error) {
      logger.error('âŒ ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆå¤±æ•—', { error });
      throw new AIServiceError('ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'CORE_ENTITY_GENERATION_FAILED');
    }
  }

  /**
   * Phase 2: è¿½åŠ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆ
   * å ±é…¬ãƒ»ä½“é¨“å‘ä¸Šç³»ã®ãƒœãƒ¼ãƒŠã‚¹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç”Ÿæˆ
   */
  private async generateBonusEntities(
    request: MilestoneGenerationRequest,
    coreEntities: any
  ): Promise<any> {
    logger.info('ğŸ è¿½åŠ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆé–‹å§‹');

    const aiService = getAIService();
    
    const prompt = `
ä»¥ä¸‹ã®æ¡ä»¶ã§è¿½åŠ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆãƒœãƒ¼ãƒŠã‚¹ç³»ï¼‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

**ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æƒ…å ±:**
${JSON.stringify(coreEntities, null, 2)}

**ç”Ÿæˆè¦ä»¶:**
1. **å®Ÿç”¨çš„å ±é…¬ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£**: 2å€‹ç¨‹åº¦ï¼ˆè£…å‚™ã€å›å¾©ã‚¢ã‚¤ãƒ†ãƒ ã€ã‚¹ã‚­ãƒ«å¼·åŒ–ï¼‰
2. **ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ãƒ»åé›†ç³»ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£**: 2å€‹ç¨‹åº¦ï¼ˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ ã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ·±åŒ–ï¼‰
3. **ãƒŸã‚¹ãƒ†ãƒªãƒ¼ç³»ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£**: 2å€‹ç¨‹åº¦ï¼ˆè¬è¦ç´ ã€éš ã—è¦ç´ ï¼‰

**åˆ¶ç´„:**
- ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é€²æ—ã«ã¯å¯„ä¸ã—ãªã„
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¢ç´¢æ„æ¬²ã‚’é«˜ã‚ã‚‹
- ãƒ†ãƒ¼ãƒ: ${request.themeId}

**å‡ºåŠ›å½¢å¼:**
{
  "practicalRewards": [
    {
      "id": "practical-001",
      "name": "å¤ã„æ­¦å™¨åº«ã®ç™ºè¦‹",
      "type": "equipment",
      "description": "æ‘ã®å¤ã„å€‰åº«ã§æ­¦å™¨åº«ã‚’ç™ºè¦‹",
      "rewards": {
        "items": [
          {"name": "é­”æ³•å¼·åŒ–ã®å‰£", "effect": "æ”»æ’ƒåŠ›+15", "rarity": "rare"},
          {"name": "å®ˆè­·ã®ç›¾", "effect": "é˜²å¾¡åŠ›+12", "rarity": "uncommon"}
        ],
        "experience": 30
      }
    }
  ],
  "trophyItems": [
    {
      "id": "trophy-001", 
      "name": "å¤ã„äººå½¢ã®ç™ºè¦‹",
      "description": "æ˜”ã®è·äººãŒä½œã£ãŸç²¾å·§ãªäººå½¢",
      "rewards": {
        "items": [
          {
            "name": "æ‘å¨˜ã®äººå½¢",
            "effect": "ãªã—",
            "description": "ç‰¹ã«åŠ¹æœã¯ãªã„ãŒã€æ‘ã®æ­´å²ã‚’æ„Ÿã˜ã•ã›ã‚‹",
            "category": "trophy",
            "rarity": "unique"
          }
        ],
        "information": ["æ‘ã®å¤ã„ä¼çµ±ã«ã¤ã„ã¦"],
        "experience": 10
      }
    }
  ],
  "mysteryItems": [
    {
      "id": "mystery-001",
      "name": "è¬ã‚ã„ãŸè€äººã¨ã®é­é‡",
      "description": "æ„å‘³æ·±ãªè¨€è‘‰ã‚’æ®‹ã™è¬ã®è€äºº",
      "rewards": {
        "items": [
          {
            "name": "è¬ã®çŸ³ã“ã‚",
            "effect": "ãªã—",
            "description": "ã„ã¤ã‹å½¹ã«ç«‹ã¤ã‹ã‚‚ã—ã‚Œãªã„æ™®é€šã®çŸ³",
            "category": "mystery_item"
          }
        ],
        "information": ["æ„å‘³æ·±ãªè¨€è‘‰", "ä¸–ç•Œã®ä¸æ€è­°ã«ã¤ã„ã¦"],
        "experience": 5
      }
    }
  ]
}
`;

    try {
      const response = await aiService.chat({
        provider: 'google',
        apiKey: process.env.GOOGLE_API_KEY || '',
        message: prompt,
        persona: 'trpg_bonus_designer'
      });
      const bonusEntities = JSON.parse(response.message);
      
      logger.info('âœ… è¿½åŠ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆå®Œäº†', { 
        practical: bonusEntities.practicalRewards?.length || 0,
        trophy: bonusEntities.trophyItems?.length || 0,
        mystery: bonusEntities.mysteryItems?.length || 0
      });
      
      return bonusEntities;
    } catch (error) {
      logger.error('âŒ è¿½åŠ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆå¤±æ•—', { error });
      throw new AIServiceError('è¿½åŠ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'BONUS_ENTITY_GENERATION_FAILED');
    }
  }

  /**
   * Phase 2: å ´æ‰€é…ç½®æœ€é©åŒ–
   * ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’é©åˆ‡ãªå ´æ‰€ã«é…ç½®ã—ã€æ™‚é–“æ¡ä»¶ãƒ»å‰ææ¡ä»¶ã‚’è¨­å®š
   */
  private async generateLocationMappings(
    coreEntities: any,
    bonusEntities: any
  ): Promise<any[]> {
    logger.info('ğŸ“ å ´æ‰€é…ç½®æœ€é©åŒ–é–‹å§‹');

    const aiService = getAIService();
    
    const prompt = `
ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’é©åˆ‡ãªå ´æ‰€ã«é…ç½®ã—ã¦ãã ã•ã„ï¼š

**ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£:**
${JSON.stringify(coreEntities, null, 2)}

**ãƒœãƒ¼ãƒŠã‚¹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£:**
${JSON.stringify(bonusEntities, null, 2)}

**é…ç½®è¦ä»¶:**
1. å„å ´æ‰€ã«é©åˆ‡ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’é…ç½®
2. æ™‚é–“æ¡ä»¶ã®è¨­å®šï¼ˆday_time, night_only, anyï¼‰
3. å‰ææ¡ä»¶ã®è¨­å®šï¼ˆä»–ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®é”æˆãŒå¿…è¦ï¼‰
4. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‡ªç„¶ãªæ¢ç´¢æµã‚Œã‚’è€ƒæ…®

**å‡ºåŠ›å½¢å¼:**
[
  {
    "id": "mapping-001",
    "locationId": "village-center",
    "locationName": "æ‘ã®ä¸­å¤®åºƒå ´",
    "entityId": "npc-001",
    "entityType": "core",
    "entityCategory": "npc",
    "timeConditions": ["day_time"],
    "prerequisiteEntities": [],
    "isAvailable": true
  },
  {
    "id": "mapping-002",
    "locationId": "crime-scene", 
    "locationName": "äº‹ä»¶ç¾å ´",
    "entityId": "event-001",
    "entityType": "core",
    "entityCategory": "event",
    "timeConditions": ["any"],
    "prerequisiteEntities": []
  }
]
`;

    try {
      const response = await aiService.chat({
        provider: 'google',
        apiKey: process.env.GOOGLE_API_KEY || '',
        message: prompt,
        persona: 'trpg_location_mapper'
      });
      const locationMappings = JSON.parse(response.message);
      
      logger.info('âœ… å ´æ‰€é…ç½®æœ€é©åŒ–å®Œäº†', { 
        mappingCount: locationMappings.length
      });
      
      return locationMappings;
    } catch (error) {
      logger.error('âŒ å ´æ‰€é…ç½®æœ€é©åŒ–å¤±æ•—', { error });
      throw new AIServiceError('å ´æ‰€é…ç½®æœ€é©åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'LOCATION_MAPPING_FAILED');
    }
  }

  /**
   * Phase 3: ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è©³ç´°åŒ–
   * ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æƒ…å ±ã‚’åŸºã«ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®è©³ç´°ã‚’è¨­å®š
   */
  private async detailizeMilestones(
    milestoneOutlines: any[],
    coreEntities: any
  ): Promise<AIMilestone[]> {
    logger.info('ğŸ“ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è©³ç´°åŒ–é–‹å§‹');

    const detailedMilestones: AIMilestone[] = [];

    for (const outline of milestoneOutlines) {
      // è©²å½“ã™ã‚‹ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å–å¾—
      const relatedEntities = this.getEntitiesForMilestone(outline.id, coreEntities);
      
      const milestone: AIMilestone = {
        id: randomUUID(),
        campaignId: '', // å¾Œã§commitToDatabaseæ™‚ã«è¨­å®š
        sessionId: '', // å¾Œã§commitToDatabaseæ™‚ã«è¨­å®š
        title: outline.title,
        description: outline.description,
        type: outline.type as MilestoneType,
        targetEntityIds: relatedEntities.map((e: any) => e.id),
        targetDetails: relatedEntities.map((e: any) => ({
          entityId: e.id,
          entityType: this.getEntityTypeFromEntity(e),
          specificConditions: {
            name: e.name,
            description: e.description,
            progressContribution: e.progressContribution || 33
          }
        })),
        progressContributions: relatedEntities.map((e: any) => e.progressContribution || 33),
        status: 'pending',
        progress: 0,
        hiddenFromPlayer: true, // æ‰‹æ¢ã‚Šæ„Ÿã®ãŸã‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¯éè¡¨ç¤º
        requiredConditions: [],
        reward: {
          experiencePoints: relatedEntities.reduce((sum: number, e: any) => 
            sum + (e.rewards?.experience || 0), 0),
          items: relatedEntities.flatMap((e: any) => e.rewards?.items || []).map((item: any) => item.id || item),
          characterBenefits: {
            information: relatedEntities.flatMap((e: any) => e.rewards?.information || [])
          },
          storyProgression: "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆã«ã‚ˆã‚‹ç‰©èªé€²è¡Œ"
        },
        createdAt: new Date().toISOString(),
        completedAt: undefined
      };

      detailedMilestones.push(milestone);
    }

    logger.info('âœ… ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è©³ç´°åŒ–å®Œäº†', { 
      milestoneCount: detailedMilestones.length
    });

    return detailedMilestones;
  }

  /**
   * Phase 3: ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
   * é›£æ˜“åº¦ã€å ±é…¬ã€é€²æ—ã®ãƒãƒ©ãƒ³ã‚¹ã‚’èª¿æ•´
   */
  private async balanceSystem(
    milestones: AIMilestone[],
    coreEntities: any,
    bonusEntities: any
  ): Promise<any> {
    logger.info('âš–ï¸ ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ©ãƒ³ã‚¹èª¿æ•´é–‹å§‹');

    // çµŒé¨“å€¤ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
    const totalCoreExperience = this.calculateTotalExperience(coreEntities);
    
    const balanceRatio = 0.7; // ã‚³ã‚¢70%, ãƒœãƒ¼ãƒŠã‚¹30%ã®æ¯”ç‡
    const adjustedBonusEntities = this.adjustBonusRewards(bonusEntities, totalCoreExperience, balanceRatio);

    // é€²æ—è²¢çŒ®åº¦ã®æ­£è¦åŒ–
    const normalizedMilestones = milestones.map(milestone => {
      const totalContribution = milestone.progressContributions.reduce((sum, val) => sum + val, 0);
      if (Math.abs(totalContribution - 100) > 1) {
        // 100%ã«æ­£è¦åŒ–
        const factor = 100 / totalContribution;
        milestone.progressContributions = milestone.progressContributions.map(val => 
          Math.round(val * factor)
        );
      }
      return milestone;
    });

    const balancedSystem = {
      milestones: normalizedMilestones,
      coreEntities,
      bonusEntities: adjustedBonusEntities,
      balanceMetrics: {
        totalCoreExperience,
        totalBonusExperience: this.calculateTotalExperience(adjustedBonusEntities),
        coreEntityCount: this.countAllEntities(coreEntities),
        bonusEntityCount: this.countAllEntities(adjustedBonusEntities)
      }
    };

    logger.info('âœ… ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ©ãƒ³ã‚¹èª¿æ•´å®Œäº†', balancedSystem.balanceMetrics);

    return balancedSystem;
  }

  /**
   * Phase 3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€æ‹¬ã‚³ãƒŸãƒƒãƒˆ
   * ç”Ÿæˆã•ã‚ŒãŸã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
   */
  private async commitToDatabase(balancedSystem: any): Promise<MilestoneGenerationResponse> {
    logger.info('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€æ‹¬ã‚³ãƒŸãƒƒãƒˆé–‹å§‹');

    try {
      // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
      const insertMilestone = this.db.prepare(`
        INSERT INTO ai_milestones (
          id, campaign_id, session_id, title, description, type,
          target_entity_ids, progress_contributions, target_details,
          status, progress, hidden_from_player, required_conditions, reward, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `);

      const insertEntityPool = this.db.prepare(`
        INSERT INTO entity_pools (
          id, campaign_id, session_id, theme_id, 
          core_entities, bonus_entities, entities, generated_at, last_updated
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
      `);

      // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä¿å­˜
      const savedMilestones: AIMilestone[] = [];
      for (const milestone of balancedSystem.milestones) {
        const milestoneWithIds = {
          ...milestone,
          campaignId: balancedSystem.campaignId || '',
          sessionId: balancedSystem.sessionId || ''
        };

        insertMilestone.run(
          milestoneWithIds.id,
          milestoneWithIds.campaignId,
          milestoneWithIds.sessionId,
          milestoneWithIds.title,
          milestoneWithIds.description,
          milestoneWithIds.type,
          JSON.stringify(milestoneWithIds.targetEntityIds),
          JSON.stringify(milestoneWithIds.progressContributions),
          JSON.stringify(milestoneWithIds.targetDetails),
          milestoneWithIds.status,
          milestoneWithIds.progress,
          milestoneWithIds.hiddenFromPlayer,
          JSON.stringify(milestoneWithIds.requiredConditions),
          JSON.stringify(milestoneWithIds.reward),
          milestoneWithIds.createdAt
        );

        savedMilestones.push(milestoneWithIds);
      }

      // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ä¿å­˜
      const entityPoolId = randomUUID();
      const entityPoolData: EntityPoolCollection = {
        // å¾“æ¥ã®æ§‹é€ ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        enemies: balancedSystem.coreEntities.enemies || [],
        events: balancedSystem.coreEntities.events || [],
        npcs: balancedSystem.coreEntities.npcs || [],
        items: balancedSystem.coreEntities.items || [],
        quests: balancedSystem.coreEntities.quests || [],
        
        // æ–°ã—ã„äºŒå±¤æ§‹é€ 
        coreEntities: balancedSystem.coreEntities,
        bonusEntities: balancedSystem.bonusEntities
      };

      insertEntityPool.run(
        entityPoolId,
        balancedSystem.campaignId || '',
        balancedSystem.sessionId || '',
        balancedSystem.themeId || 'default',
        JSON.stringify(balancedSystem.coreEntities),
        JSON.stringify(balancedSystem.bonusEntities),
        JSON.stringify(entityPoolData), // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
        new Date().toISOString(),
        new Date().toISOString()
      );

      const response: MilestoneGenerationResponse = {
        milestones: savedMilestones,
        entityPool: {
        id: entityPoolId,
        campaignId: balancedSystem.campaignId || '',
        sessionId: balancedSystem.sessionId || '',
        themeId: balancedSystem.themeId || 'default',
        entities: entityPoolData,
        generatedAt: new Date().toISOString(),
        lastUpdated: new Date().toISOString()
      },
        themeAdaptation: balancedSystem.themeAdaptation || {
          allowedEntityTypes: [],
          restrictedEntityTypes: [],
          specializations: [],
          contentModifiers: []
        },
        generationMetadata: balancedSystem.generationMetadata || {
          model: 'gemini-2.0-flash-lite',
          prompt: 'Top-down scenario generation',
          tokensUsed: 0,
          processingTime: 0,
          generatedAt: new Date().toISOString()
        }
      };

      logger.info('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€æ‹¬ã‚³ãƒŸãƒƒãƒˆå®Œäº†', { 
        milestonesCount: savedMilestones.length,
        entityPoolId
      });

      return response;

    } catch (error) {
      logger.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€æ‹¬ã‚³ãƒŸãƒƒãƒˆå¤±æ•—', { error });
      throw new AIServiceError('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'DATABASE_COMMIT_FAILED');
    }
  }

  // =============================================================================
  // ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ç¾¤
  // =============================================================================

  private getEntitiesForMilestone(milestoneId: string, coreEntities: any): any[] {
    const allEntities = [
      ...(coreEntities.enemies || []),
      ...(coreEntities.events || []),
      ...(coreEntities.npcs || []),
      ...(coreEntities.items || []),
      ...(coreEntities.quests || [])
    ];
    
    return allEntities.filter((entity: any) => entity.milestoneId === milestoneId);
  }

  private getEntityTypeFromEntity(entity: any): 'enemy' | 'event' | 'npc' | 'item' | 'quest' {
    // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æ§‹é€ ã‹ã‚‰å‹ã‚’æ¨å®š
    if (entity.level !== undefined) return 'enemy';
    if (entity.rewards && entity.description) return 'event';
    if (entity.relationships) return 'npc';
    if (entity.effect) return 'item';
    return 'quest';
  }

  private calculateTotalExperience(entities: any): number {
    if (!entities) return 0;
    
    let total = 0;
    Object.values(entities).forEach((entityList: any) => {
      if (Array.isArray(entityList)) {
        total += entityList.reduce((sum: number, entity: any) => 
          sum + (entity.rewards?.experience || 0), 0);
      }
    });
    
    return total;
  }

  private countAllEntities(entities: any): number {
    if (!entities) return 0;
    
    let count = 0;
    Object.values(entities).forEach((entityList: any) => {
      if (Array.isArray(entityList)) {
        count += entityList.length;
      }
    });
    
    return count;
  }

  private adjustBonusRewards(bonusEntities: any, coreExperience: number, ratio: number): any {
    // ãƒœãƒ¼ãƒŠã‚¹å ±é…¬ã‚’é©åˆ‡ãªæ¯”ç‡ã«èª¿æ•´
    const targetBonusExperience = coreExperience * ratio / (1 - ratio);
    const currentBonusExperience = this.calculateTotalExperience(bonusEntities);
    
    if (currentBonusExperience === 0) return bonusEntities;
    
    const adjustmentFactor = targetBonusExperience / currentBonusExperience;
    
    // å„ãƒœãƒ¼ãƒŠã‚¹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®çµŒé¨“å€¤ã‚’èª¿æ•´
    const adjusted = { ...bonusEntities };
    Object.keys(adjusted).forEach(key => {
      if (Array.isArray(adjusted[key])) {
        adjusted[key] = adjusted[key].map((entity: any) => ({
          ...entity,
          rewards: {
            ...entity.rewards,
            experience: Math.round((entity.rewards?.experience || 0) * adjustmentFactor)
          }
        }));
      }
    });
    
    return adjusted;
  }
}

// Lazy initialization
let _aiMilestoneGenerationService: AIMilestoneGenerationService | null = null;
export function getAIMilestoneGenerationService(): AIMilestoneGenerationService {
  if (!_aiMilestoneGenerationService) {
    _aiMilestoneGenerationService = new AIMilestoneGenerationService();
  }
  return _aiMilestoneGenerationService;
}